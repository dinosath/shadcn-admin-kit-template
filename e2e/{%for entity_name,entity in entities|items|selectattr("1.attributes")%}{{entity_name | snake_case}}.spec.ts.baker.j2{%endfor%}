{% for entity_name, entity in entities | items | selectattr("1.attributes") -%}
import { test, expect } from '@playwright/test';

{% if authentication != 'none' -%}
// Helper to login before tests
async function loginAsAdmin(page: import('@playwright/test').Page) {
  const adminPassword = process.env.ADMIN_PASSWORD || 'testpassword';
  
  await page.goto('/');
  await page.getByLabel(/email/i).fill('admin');
  await page.getByLabel(/password/i).fill(adminPassword);
  await page.getByRole('button', { name: /sign in/i }).click();
  
  // Wait for dashboard to load
  await expect(page.getByText(/dashboard/i)).toBeVisible({ timeout: 10000 });
}
{% endif %}

test.describe('{{ entity_name | title }} Resource', () => {
{% if authentication != 'none' -%}
  test.beforeEach(async ({ page }) => {
    await loginAsAdmin(page);
  });
{% endif %}

  test('should navigate to {{ entity_name | plural | lower }} list', async ({ page }) => {
{% if authentication == 'none' -%}
    await page.goto('/');
{% endif %}
    
    // Click on the {{ entity_name | plural }} menu item
    await page.getByRole('link', { name: /{{ entity_name | plural | lower }}/i }).click();
    
    // Should show the list page
    await expect(page.url()).toContain('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
  });

  test('should show create button on list page', async ({ page }) => {
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% if authentication != 'none' -%}
    await loginAsAdmin(page);
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% endif %}
    
    // Should have a create button
    await expect(page.getByRole('link', { name: /create/i })).toBeVisible({ timeout: 10000 });
  });

  test('should open create form', async ({ page }) => {
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}/create');
{% if authentication != 'none' -%}
    await loginAsAdmin(page);
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}/create');
{% endif %}
    
    // Should show a form
    await expect(page.locator('form')).toBeVisible({ timeout: 10000 });
    
    // Should have save button
    await expect(page.getByRole('button', { name: /save/i })).toBeVisible();
  });

  test('should create a new {{ entity_name | lower }}', async ({ page }) => {
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}/create');
{% if authentication != 'none' -%}
    await loginAsAdmin(page);
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}/create');
{% endif %}
    
    // Fill in the form with test data
{% for name, property in entity.attributes | items -%}
{% if not property.readOnly and property.type != 'relation' -%}
{% if property.type == 'string' -%}
{% if property.format == 'email' -%}
    await page.getByLabel(/{{ name | snake_case | replace("_", " ") }}/i).fill('test{{ loop.index }}@example.com');
{% else -%}
    await page.getByLabel(/{{ name | snake_case | replace("_", " ") }}/i).fill('Test {{ name | title }} {{ loop.index }}');
{% endif -%}
{% elif property.type == 'text' -%}
    await page.getByLabel(/{{ name | snake_case | replace("_", " ") }}/i).fill('Test {{ name | title }} content');
{% elif property.type == 'integer' -%}
    await page.getByLabel(/{{ name | snake_case | replace("_", " ") }}/i).fill('{{ property.default | default(loop.index) }}');
{% elif property.type == 'boolean' -%}
    // Boolean field - click if needed
    const {{ name | camel_case }}Checkbox = page.getByLabel(/{{ name | snake_case | replace("_", " ") }}/i);
    if (await {{ name | camel_case }}Checkbox.isVisible()) {
      await {{ name | camel_case }}Checkbox.check();
    }
{% endif -%}
{% endif -%}
{% endfor %}
    
    // Submit the form
    await page.getByRole('button', { name: /save/i }).click();
    
    // Should redirect to list or show success
    await expect(page.url()).not.toContain('/create');
  });

  test('should show {{ entity_name | lower }} details', async ({ page }) => {
    // First create a record, then view it
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% if authentication != 'none' -%}
    await loginAsAdmin(page);
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% endif %}
    
    // Wait for list to load
    await page.waitForLoadState('networkidle');
    
    // Click on first row's show button if available
    const showButton = page.getByRole('link', { name: /show/i }).first();
    if (await showButton.isVisible()) {
      await showButton.click();
      await expect(page.url()).toMatch(/\/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}\/\d+\/show/);
    }
  });

  test('should edit {{ entity_name | lower }}', async ({ page }) => {
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% if authentication != 'none' -%}
    await loginAsAdmin(page);
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% endif %}
    
    // Wait for list to load
    await page.waitForLoadState('networkidle');
    
    // Click on first row's edit button if available
    const editButton = page.getByRole('link', { name: /edit/i }).first();
    if (await editButton.isVisible()) {
      await editButton.click();
      
      // Should show edit form
      await expect(page.locator('form')).toBeVisible({ timeout: 10000 });
      await expect(page.getByRole('button', { name: /save/i })).toBeVisible();
    }
  });

  test('should delete {{ entity_name | lower }}', async ({ page }) => {
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% if authentication != 'none' -%}
    await loginAsAdmin(page);
    await page.goto('/{{ entity.info.pluralName | default(entity_name | plural | snake_case) }}');
{% endif %}
    
    // Wait for list to load
    await page.waitForLoadState('networkidle');
    
    // Click on first row's delete button if available
    const deleteButton = page.getByRole('button', { name: /delete/i }).first();
    if (await deleteButton.isVisible()) {
      await deleteButton.click();
      
      // Confirm deletion if dialog appears
      const confirmButton = page.getByRole('button', { name: /confirm|yes|delete/i });
      if (await confirmButton.isVisible()) {
        await confirmButton.click();
      }
    }
  });
});
{% endfor -%}
