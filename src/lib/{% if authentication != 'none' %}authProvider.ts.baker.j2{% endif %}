{% if authentication == 'jwt' -%}
import { type AuthProvider } from 'ra-core';

const API_URL = '/auth';

interface LoginParams {
    email?: string;
    username?: string;
    password: string;
}

interface AuthResponse {
    access_token: string;
    token_type: string;
    expires_in: number;
}

interface UserIdentity {
    id: string;
    fullName?: string;
    avatar?: string;
}

export const authProvider: AuthProvider = {
    login: async ({ email, username, password }: LoginParams) => {
        const loginUsername = email || username;
        if (!loginUsername) {
            throw new Error('Username or email is required');
        }

        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: loginUsername,
                password,
            }),
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({ error: 'Login failed' }));
            throw new Error(error.error || 'Invalid credentials');
        }

        const auth: AuthResponse = await response.json();
        localStorage.setItem('auth', JSON.stringify(auth));
        localStorage.setItem('token', auth.access_token);
        return auth;
    },

    logout: async () => {
        localStorage.removeItem('auth');
        localStorage.removeItem('token');
        localStorage.removeItem('identity');
        return Promise.resolve();
    },

    checkAuth: async () => {
        const token = localStorage.getItem('token');
        if (!token) {
            throw new Error('Not authenticated');
        }
        return Promise.resolve();
    },

    checkError: async (error: { status?: number; message?: string }) => {
        const status = error?.status;
        if (status === 401 || status === 403) {
            localStorage.removeItem('auth');
            localStorage.removeItem('token');
            localStorage.removeItem('identity');
            throw new Error('Session expired');
        }
        return Promise.resolve();
    },

    getIdentity: async (): Promise<UserIdentity> => {
        const cachedIdentity = localStorage.getItem('identity');
        if (cachedIdentity) {
            return JSON.parse(cachedIdentity);
        }

        const token = localStorage.getItem('token');
        if (!token) {
            throw new Error('Not authenticated');
        }

        try {
            const response = await fetch(`${API_URL}/me`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            });

            if (!response.ok) {
                throw new Error('Failed to fetch identity');
            }

            const userInfo = await response.json();
            const identity: UserIdentity = {
                id: userInfo.user_id,
                fullName: userInfo.user_id,
            };
            localStorage.setItem('identity', JSON.stringify(identity));
            return identity;
        } catch {
            // If fetching identity fails, use token payload
            const identity: UserIdentity = {
                id: 'user',
                fullName: 'User',
            };
            localStorage.setItem('identity', JSON.stringify(identity));
            return identity;
        }
    },

    getPermissions: async () => {
        const token = localStorage.getItem('token');
        if (!token) {
            return [];
        }

        try {
            const response = await fetch(`${API_URL}/me`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            });

            if (!response.ok) {
                return [];
            }

            const userInfo = await response.json();
            return userInfo.roles || [];
        } catch {
            return [];
        }
    },
};

// Helper function to get the auth token for API calls
export const getAuthToken = (): string | null => {
    return localStorage.getItem('token');
};

// Helper function to get auth headers for fetch requests
export const getAuthHeaders = (): HeadersInit => {
    const token = getAuthToken();
    if (token) {
        return {
            'Authorization': `Bearer ${token}`,
        };
    }
    return {};
};
{% elif authentication == 'oidc' -%}
import { type AuthProvider } from 'ra-core';

const API_URL = '/auth';

interface UserIdentity {
    id: string;
    fullName?: string;
    avatar?: string;
}

export const authProvider: AuthProvider = {
    login: async () => {
        // For OIDC, redirect to the auth endpoint
        window.location.href = `${API_URL}/login`;
        return Promise.resolve();
    },

    logout: async () => {
        localStorage.removeItem('identity');
        // Optionally redirect to OIDC logout
        window.location.href = `${API_URL}/logout`;
        return Promise.resolve();
    },

    checkAuth: async () => {
        // Check if user has a valid session by calling the /me endpoint
        try {
            const response = await fetch(`${API_URL}/me`, {
                credentials: 'include',
            });

            if (!response.ok) {
                throw new Error('Not authenticated');
            }
            return Promise.resolve();
        } catch {
            throw new Error('Not authenticated');
        }
    },

    checkError: async (error: { status?: number; message?: string }) => {
        const status = error?.status;
        if (status === 401 || status === 403) {
            localStorage.removeItem('identity');
            throw new Error('Session expired');
        }
        return Promise.resolve();
    },

    getIdentity: async (): Promise<UserIdentity> => {
        const cachedIdentity = localStorage.getItem('identity');
        if (cachedIdentity) {
            return JSON.parse(cachedIdentity);
        }

        try {
            const response = await fetch(`${API_URL}/me`, {
                credentials: 'include',
            });

            if (!response.ok) {
                throw new Error('Failed to fetch identity');
            }

            const userInfo = await response.json();
            const identity: UserIdentity = {
                id: userInfo.sub || userInfo.user_id,
                fullName: userInfo.name || userInfo.preferred_username,
                avatar: userInfo.picture,
            };
            localStorage.setItem('identity', JSON.stringify(identity));
            return identity;
        } catch {
            throw new Error('Failed to fetch identity');
        }
    },

    getPermissions: async () => {
        try {
            const response = await fetch(`${API_URL}/me`, {
                credentials: 'include',
            });

            if (!response.ok) {
                return [];
            }

            const userInfo = await response.json();
            return userInfo.roles || [];
        } catch {
            return [];
        }
    },
};

// Helper function to get auth headers for fetch requests (uses cookies for OIDC)
export const getAuthHeaders = (): HeadersInit => {
    return {};
};
{% endif -%}
